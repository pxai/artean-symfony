{% extends "CuatrovientosArteanBundle:Default:layout.html.twig" %}
{% block title %}Artean :: Mailings : Detalle mailing{% endblock %}
{% block body %}
    <h2><i class="fa fa-envelope" aria-hidden="true"></i> Mailing</h2>

    <a href="{{ path('cuatrovientos_artean_mailing') }}" class="btn">
        <i class="fa fa-list-alt" aria-hidden="true"></i> Ver todos
    </a>
    <h3><i class="fa fa-search-plus" aria-hidden="true"></i> Detalle de mailing</h3>
    <a href="{{ path('cuatrovientos_artean_mailing_update', {'id': mailing.id }) }}" class="btn btn-warning"><i class="fa fa-edit" aria-hidden="true"></i> Modificar</a>
    <ul>
     <li><strong>Id: </strong>{{ mailing.id }}</li> 
     <li><strong>De: </strong>{{ mailing.mailFrom }}</li>
        <li><strong>Para: </strong>{{ mailing.mailTo }}</li>
        <li><strong>Copia oculta: </strong>{{ mailing.bcc }}</li>
        <li><strong>Asunto: </strong>{{ mailing.subject }}</li>
        <li><strong>Mensaje: </strong>{{ mailing.body }}</li>
        <li><strong>Fecha: </strong>{{ mailing.mailDate }}</li>
        <li><strong>Tipo de mailing: </strong>{{ mailing.type }}</li>
    </ul>
		{#% if is_granted('ROLE_ADMIN') %#}
                <a href="{{ path('cuatrovientos_artean_mailing') }}">Index</a> |
                <a href="{{ path('cuatrovientos_artean_mailing_update', {'id': mailing.id }) }}">Update</a> |
                <a href="{{ path('cuatrovientos_artean_mailing_delete', {'id': mailing.id }) }}">Delete</a>                      
		{#% endif % #}

    <h3>1. Seleccionar destinatarios<i class="fa fa-user-plus" aria-hidden="true"></i></h3>
    <button type="button" class="btn btn-info" data-toggle="modal" data-target="#addPrecandidates">
        <i class="fa fa-user-plus" aria-hidden="true"></i>
        Candidatos
    </button>
    <button type="button" class="btn btn-info" data-toggle="modal" data-target="#addCompanies">
        <i class="fa fa-industry" aria-hidden="true"></i>
        Empresas
    </button>

    <!-- Modal -->
    <div class="modal fade" id="addPrecandidates" tabindex="-1" role="dialog" aria-labelledby="addPrecandidates" aria-hidden="true">
        <div class="modal-dialog  modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel"> <i class="fa fa-users" aria-hidden="true"></i> Añadir precandidatos</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    {% include "CuatrovientosArteanBundle:Mailing:advancedSearch.html.twig" %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="showApplicant" tabindex="-1" role="dialog" aria-labelledby="showApplicant" aria-hidden="true">
        <div class="modal-dialog  modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel"> <i class="fa fa-users" aria-hidden="true"></i> Añadir precandidatos</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="addCompanies" tabindex="-1" role="dialog" aria-labelledby="addCompanies" aria-hidden="true">
        <div class="modal-dialog  modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel"> <i class="fa fa-users" aria-hidden="true"></i> Añadir precandidatos</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    {% include "CuatrovientosArteanBundle:Mailing:companySearch.html.twig" %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block extrascripts %}
    <script language="javascript">
        var preselected = [];

        $('#applicant_search').click(function (e) {
            e.preventDefault();
            console.log($(this).attr('href'));
            var formSerialized = $('#applicant_search_form').serialize();
            load($(this).attr('href'));
            function load (url) {

                $.ajax({
                    url: url,
                    type: 'POST',
                    dataType: 'html',
                    data: formSerialized,
                    error: function() {
                        showResults('Error en la búsqueda');
                    },
                    success: function(res) {
                        if (res.length === 0) {
                            showResults('No se encontró ningún registro');
                        } else {
                            //console.log("SUCCESS " + res);
                            //updateArray(res);
                            showResults(res);
                        }
                    }
                });
            }

            function updateArray(applicants) {
                applicants.forEach(function (applicant) {
                    var result = $.grep(preselected, function(e){ return e.id == applicant.id; });
                    if (result.length == 0) {
                        preselected.push(applicant);
                    }
                });
                $("#preselected_applicant_list").empty();
                preselected.forEach(function (applicant) {
                    $("#preselected_applicant_list").append($("<option></option>")
                            .attr("value", applicant.id).text(applicant.surname+', '+applicant.name));
                });
                console.log(applicants);
            }

            function showResults(msg) {
                $("#preselected_applicant_list").html(msg);
                $('#applicant_search_result').css("display", "block");
            }
        });

        var selected = false;
        $('#select_all').click(function() {
            selected = !selected;
            $('#preselected_applicant_list option').prop('selected', selected);
        });

        $('.applicant_detail').click(function (e) {
            e.preventDefault();
            console.log($(this).attr('href'));
            load($(this).attr('href'));
            function load (url) {
                $.ajax({
                    url: url,
                    type: 'GET',
                    dataType: 'html',
                    data: {
                    },
                    error: function() {
                        $('#showApplicant div.modal-body').html('Error al modificar.');//res;
                        $('#showApplicant').modal('show');
                    },
                    success: function(res) {
                        if (res.length === 0) {
                            console.log('Nothing found');
                        } else {
                            console.log("SUCCESS");
                            $('#showApplicant div.modal-body').html(res);//res;
                            $('#showApplicant').modal('show');
                        }
                    }
                });
            }
        });

        $('.delete_preselected').click(function (e) {
            e.preventDefault();
            var applicantid = $(this).data("id");
            console.log($(this).attr('href') + ":" + applicantid);
            load($(this).attr('href'));

            //var itemForSymfony['jobrequest'] = item;
            function load (url) {
                $.ajax({
                    url: url,
                    type: 'GET',
                    dataType: 'json',
                    error: function() {
                        $('#showApplicant div.modal-body').html('Error al eliminar.');//res;
                        $('#showApplicant').modal('show');
                    },
                    success: function(res) {
                        console.log("Result: " + res);
                        var result = JSON.parse(res);
                        if (result.result === 1) {
                            $('#preselected_applicant_id_'+applicantid).fadeOut(1000);
                            $('#preselected_applicant_id_'+applicantid).remove();
                        } else {
                            $('#showApplicant div.modal-body').html('No se pudo eliminar.');//res;
                            $('#showApplicant').modal('show');

                        }
                    }
                });
            }
        });


        $('.add_selected').click(function (e) {
            e.preventDefault();
            var applicantid = $(this).data("id");
            console.log($(this).attr('href') + ":" + applicantid);
            load($(this).attr('href'));

            //var itemForSymfony['jobrequest'] = item;
            function load (url) {
                $.ajax({
                    url: url,
                    type: 'GET',
                    dataType: 'html',
                    error: function() {
                        $('#showApplicant div.modal-body').html('Error al modificar.');//res;
                        $('#showApplicant').modal('show');
                    },
                    success: function(res) {
                        console.log("Result: " + res);
                        if (res !== 0) {
                            // $('#showApplicant div.modal-body').html(res);//res;
                            // $('#showApplicant').modal('show');
                            $('#preselected_applicant_id_'+applicantid).fadeOut(1000);
                            $('#preselected_applicant_id_'+applicantid).remove();
                            $('table#selected_applicants').append(res);
                        } else {
                            $('#showApplicant div.modal-body').html('No se pudo mover.');//res;
                            $('#showApplicant').modal('show');

                        }
                    }
                });
            }
        });
    </script>
{% endblock %}